<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1"/>
  <title>Force Directed Graph</title>
  <script type="text/javascript" src="../lib/d3-v3.2.8.js"></script>
</head>
<body>
<style type="text/css">
  .node {
  cursor: pointer;
  stroke: #3182bd;
  stroke-width: 1.5px;
}

.link {
  fill: none;
  stroke: #9ecae1;
  stroke-width: 1.5px;
}
</style>
</body>
<script type="text/javascript">

function flatten(root) {
  var nodes = [];
  function traverse(node, depth) {
    if (node.children) {
      node.children.forEach(function(child) {
        child.parent = node;
        traverse(child, depth + 1);
      });
    }
    node.depth = depth;
    nodes.push(node);
  }
  traverse(root, 1);
  return nodes;
}

function tick(){
  link.attr("x1", function(d) { return d.source.x; })
      .attr("y1", function(d) { return d.source.y; })
      .attr("x2", function(d) { return d.target.x; })
      .attr("y2", function(d) { return d.target.y; });
  node.attr("cx", function(d) { return d.x; })
      .attr("cy", function(d) { return d.y; });
}

var w = 1200,
  h = 800,
  z = d3.scale.category20();

var force = d3.layout.force()
  .gravity(.05)
  .distance(120)
  .charge(-100)
  .size([w, h])
  .on('tick', tick);

var svg = d3.select("body").append("svg")
  .attr("width", w)
  .attr("height", h);

var link = svg.selectAll('.link'),
  node = svg.selectAll('.node');

function get_root(index){
  if (index == 1) {
    return {
      "name": "flare",
      "children": [
        { "name": "analytics", "children":
          [
            {"name": "BetweennessCentrality", "size": 3534},
            {"name": "SpanningTree", "size": 3416},
            {"name": "ArrayInterpolator", "size": 1983}
          ]
        },
        {"name": "ColorInterpolator", "size": 2047},
        {"name": "DateInterpolator", "size": 1375}
      ]
    };
  }
  else if (index == 2) {
    return {
      "name": "flare",
      "children": [
        { "name": "analytics", "children":
          [
            {"name": "BetweennessCentrality", "size": 3534},
            {"name": "SpanningTree", "size": 3416},
            {"name": "ArrayInterpolator", "size": 1983}
          ]
        },
        {"name": "ColorInterpolator", "children": [
          {"name": "ISchedulable", "size": 1041},
            {"name": "Parallel", "size": 5176},
            {"name": "Pause", "size": 449}
        ]},
        {"name": "DateInterpolator", "size": 1375}
      ]
    };
  }
  return {
    "name": "flare",
    "children": [
      { "name": "analytics", "children":
        [
          {"name": "BetweennessCentrality", "size": 3534},
          {"name": "SpanningTree", "size": 3416},
          {"name": "ArrayInterpolator", "size": 1983}
        ]
      }
    ]
  }
}

// 创建箭头
var defs = svg.append("defs");
var arrowMarker = defs.append("marker")
            .attr("id","arrow")
            .attr("markerUnits","strokeWidth")
            .attr("markerWidth","6")
            .attr("markerHeight","12")
            .attr("viewBox","0 0 12 12")
            .attr("refX","18")
            .attr("refY","6")
            .attr("orient","auto");
var arrow_path = "M2,2 L10,6 L2,10 L6,6 L2,2";
arrowMarker.append("path")
      .attr("d",arrow_path)
      .attr("fill","#333");

// 更新页面
function update(data) {
  var nodes = flatten(data),
    links = d3.layout.tree().links(nodes);

  // Restart the force layout.
  force.nodes(nodes).links(links).start();

  // Update the links…
  link = link.data(links);

  // Enter any new links.
  link.enter().insert("line", ".node")
    .attr("class", "link")
    .style("fill", "#3182bd")
    .attr("x1", function(d) { return d.source.x; })
    .attr("y1", function(d) { return d.source.y; })
    .attr("x2", function(d) { return d.target.x; })
    .attr("y2", function(d) { return d.target.y; })
    // 添加箭头
    .attr("stroke", "red")
    .attr("stroke-width", 2)
    .attr("marker-end","url(#arrow)");

  // Exit any old links.
  link.exit().remove();

  // Update the nodes…
  node = node.data(nodes);

  // Exit any old nodes.
    node.exit().remove();

  // Enter any new nodes.
  node.enter().append("circle")
    .attr("class", "node")
    .attr("cx", function(d) { return d.x; })
    .attr("cy", function(d) { return d.y; })
    .attr("r", function(d) { return Math.sqrt(d.size) / 10 || 4.5; })
    .on("click", click)   // 添加点击事件
    .call(force.drag);

  // 添加颜色
  node.attr("data", function(d) { return d.depth; })
  node.style("fill", color)

  //(2)根据连线类型引用上面创建的标记
  var path = svg.append("svg:g").selectAll("path")
    .data(links)
    .enter().append("svg:path")
    .attr("class", function(d) { return "link " + d.type; })
    .attr("marker-end", function(d) { return "url(#" + d.type + ")"; });
}


function click(e) {
  console.log(e)
}

// Color leaf nodes orange, and packages white or blue.
function color(d) {
  var colors = ['red', 'blue', 'yellow', 'orange'];
  return colors[d.depth-1];
}

data = get_root(0)
update(data)

setTimeout(function(){
  data = get_root(1)
  update(data)
}, 5000)

setTimeout(function(){
  data = get_root(2)
  update(data)
}, 10000)
</script>
</html>