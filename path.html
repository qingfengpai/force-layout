<!DOCTYPE html>
<html>
<head>
<title>传播路径可视化</title>
<meta charset="utf-8">
<style type="text/css">
#progress {
	position: fixed;
	top: 0;
	left: -6px;
	width: 0%;
	height: 2px;
	background: red;
}
#progress:before,
#progress:after {
	content: "";
	position: absolute;
	height: 2px;
	opacity: 0.6;
	box-shadow: red 1px 0 6px 1px;
	border-radius: 100%;
}
#progress:before {
	width: 20px;
	right: 0;
	clip: rect(-6px, 22px, 14px, 10px);
}
#progress:after {
	width: 180px;
	right: -80px;
	clip: rect(-6px, 90px, 14px, -6px);
}

</style>
<link rel="stylesheet" type="text/css" href="../css/index.css">
<script src="../lib/d3-v4.7.4.min.js"></script>
<script src="../lib/d3-v4.7.4.min.js"></script>
</head>
<body>
<div id="progress"></div>
</body>
<script type="text/javascript">
var meter = document.querySelector("#progress");

var width = 960,
	height = 600;
var context = d3.select("body").append("canvas")
	.attr("id", "canvas")
	.attr("width", width)
	.attr("height", height)
	.call(d3.zoom().scaleExtent([1, 8]).on("zoom", zoom))
	.on("mousemove", function(d) {
		var p = d3.mouse(this);
		// var node = simulation.find(p[0], p[1]);
		console.log(p);
	})
	.node().getContext("2d");

function over(){
	console.log(d3.event);

}

var worker = new Worker("js/path.js");

worker.onmessage = function(event) {
	switch (event.data.type) {
		case "tick": return ticked(event.data);
		case "end": return end(event.data);
	}
};

var GD_data;

d3.request("../data/path-link-85f0c2.json")
	.mimeType("application/json")
	.response(function(xhr) {
		GD_data = JSON.parse(xhr.responseText);
		worker.postMessage(GD_data);
	})
	.get()
;

function zoom() {
	context.save();
	context.clearRect(0, 0, width, height);
	context.translate(d3.event.transform.x, d3.event.transform.y);
	context.scale(d3.event.transform.k, d3.event.transform.k);
	draw();
	context.restore();
}


function ticked(data) {
	var progress = data.progress;
	meter.style.width = 100 * progress + "%";
}

function end(data) {
	GD_data = data;
	draw(GD_data);
}

function draw() {
	var nodes = GD_data.nodes,
	  	links = GD_data.links;

	meter.style.display = "none";

	context.clearRect(0, 0, width, height);
	context.save();
	context.translate(width / 2, height / 2);

	context.beginPath();
	links.forEach(drawLink);
	context.strokeStyle = "#aaa";
	context.stroke();

	context.beginPath();
	nodes.forEach(drawNode);
	context.fill();
	context.strokeStyle = "#fff";
	context.stroke();

	context.restore();
}

function drawLink(d) {
	context.moveTo(d.source.x, d.source.y);
	context.lineTo(d.target.x, d.target.y);
}

function drawNode(d) {
	context.moveTo(d.x + 3, d.y);
	context.arc(d.x, d.y, 3, 0, 2 * Math.PI);
}
</script>
</html>